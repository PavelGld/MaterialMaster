# Архитектура приложения

## Обзор системы

Приложение представляет собой веб-систему анализа материалов, построенную по модульной архитектуре с четким разделением ответственности между компонентами.

## Архитектурные принципы

- **Модульность**: Каждый сервис отвечает за определенную функциональность
- **Разделение слоев**: Представление, бизнес-логика и данные разделены
- **Расширяемость**: Легко добавлять новые виды анализа и форматы
- **Интернационализация**: Поддержка множественных языков заложена в архитектуру

## Структура компонентов

### Основные модули

```
app.py                 # Flask приложение и маршруты
├── config.py          # Конфигурация системы
├── main.py           # Точка входа
└── services/         # Бизнес-логика
    ├── ai_service.py     # ИИ анализ материалов
    ├── ocr_service.py    # OCR обработка изображений
    ├── pdf_service_unicode.py  # Генерация PDF отчетов
    └── vector_service.py # Векторный поиск материалов
```

### Вспомогательные модули

```
utils/
├── file_utils.py     # Утилиты работы с файлами
templates/            # HTML шаблоны
├── base.html        # Базовый шаблон
├── index.html       # Главная страница
└── analysis.html    # Страница результатов
static/              # Статические ресурсы
├── css/style.css   # Стили приложения
└── js/main.js      # JavaScript логика
translations/        # Файлы переводов
└── ru/LC_MESSAGES/ # Русская локализация
```

## Поток данных

### 1. Пользовательский ввод
```
Пользователь → Веб-форма → Flask маршрут /analyze
```

### 2. Обработка входных данных
```
Текстовое описание ────┐
                       ├─→ Объединение данных
Изображение → OCR ─────┘
```

### 3. ИИ анализ
```
Объединенные данные → AI Service → Структурированный анализ
```

### 4. Генерация отчета
```
Анализ → PDF Service → PDF файл → Пользователь
```

## Описание сервисов

### AIService
**Назначение**: Анализ материалов с использованием Google Gemini

**Основные методы**:
- `analyze_material_requirements()` - главный метод анализа
- `_get_system_prompt()` - формирование системного промпта
- `_parse_ai_response()` - парсинг JSON ответа от ИИ

**Входные данные**: Текстовое описание материала
**Выходные данные**: JSON структура с разделами анализа

### OCRService
**Назначение**: Извлечение текста из изображений документов

**Основные методы**:
- `extract_text()` - извлечение текста из изображения
- `_clean_text()` - очистка и нормализация текста
- `is_tesseract_available()` - проверка доступности OCR

**Технологии**: Tesseract OCR, Pillow
**Поддерживаемые форматы**: PNG, JPEG

### PDFService
**Назначение**: Генерация PDF отчетов с поддержкой Unicode

**Основные методы**:
- `generate_report()` - создание PDF документа
- `_register_fonts()` - регистрация Unicode шрифтов
- `_clean_text()` - подготовка текста для PDF

**Особенности**:
- Автоматическое определение доступных шрифтов
- Fallback на транслитерацию при отсутствии Unicode шрифтов
- Поддержка русского и английского языков

### VectorService
**Назначение**: Векторный поиск и рекомендации материалов

**Основные методы**:
- `search_similar_materials()` - поиск похожих материалов
- `get_material_recommendations()` - получение рекомендаций
- `add_material()` - добавление нового материала

**Технологии**: FAISS, NumPy для векторных операций

## Система переводов

### Архитектура локализации
```
simple_gettext() ─→ Словарь переводов ─→ Локализованный текст
                 ↑
            get_locale() определяет язык
```

### Источники переводов
- `app.py` - функция `simple_gettext()` с встроенным словарем
- `translations/` - файлы .po/.mo для расширенной локализации

## Управление состоянием

### Сессии Flask
- Хранение языковых предпочтений
- ID анализа для связи с временными файлами

### Временное хранилище
```
temp_analysis/
├── {uuid}.json  # Результаты анализа
uploads/
├── {timestamp}_{filename}  # Загруженные изображения
```

**Причина**: Flask сессии ограничены 4KB, большие данные анализа сохраняются в файлах

## Безопасность

### Загрузка файлов
- Проверка расширений файлов
- Ограничение размера (16MB)
- Временное хранение с автоочисткой

### API ключи
- Чтение из переменных окружения
- Никогда не храним в коде
- Отдельная конфигурация для разработки/продакшн

### Обработка ошибок
```python
try:
    # Операция
except Exception as e:
    logger.error(f"Error: {str(e)}")
    # Пользовательское сообщение об ошибке
```

## Производительность

### Оптимизации
- Асинхронная загрузка статических ресурсов
- Кэширование переводов
- Оптимизация размеров изображений для OCR
- Пул соединений для HTTP запросов

### Масштабирование
- Stateless архитектура для горизонтального масштабирования
- Файловое хранилище может быть заменено на Redis/Database
- Готовность к контейнеризации (Docker)

## Мониторинг и логирование

### Уровни логирования
```python
DEBUG   # Детальная отладочная информация
INFO    # Информационные сообщения
WARNING # Предупреждения о проблемах
ERROR   # Ошибки выполнения
```

### Источники логов
- Flask application logs
- Gunicorn access/error logs
- Service-specific logs (AI, OCR, PDF)

## Развитие архитектуры

### Планируемые улучшения
1. **База данных**: Переход с файлового хранилища на PostgreSQL
2. **Кэширование**: Добавление Redis для кэширования результатов
3. **Асинхронность**: Celery для длительных операций OCR/AI
4. **API**: REST API для интеграции с внешними системами
5. **Микросервисы**: Выделение сервисов в отдельные контейнеры

### Точки расширения
- Новые модели ИИ через единый интерфейс AIService
- Дополнительные форматы документов в OCRService
- Новые форматы отчетов в PDFService
- Интеграция с внешними базами материалов